@page "/"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Threading.Tasks

<PageTitle>Character Sheet</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-md-4">
            <select value="@Model.CharacterName" @onchange="e => LoadCharacter(e.Value?.ToString())" class="form-control">
                <option value="">-- Select Character --</option>
                @foreach(var character in AvailableCharacters)
                {
                    <option value="@character.CharacterName">@character.CharacterName</option>
                }
            </select>
        </div>
        <div class="col-md-4">
            <div class="row">
                <div class="col-4">
                    <button class="btn btn-primary" @onclick="NewCharacter">New</button>
                </div>
                <div class="col-4">
                    <button class="btn btn-success" @onclick="SaveCharacter">Save</button>
                </div>
                <div class="col-4">
                    <button class="btn btn-outline-primary" @onclick="Nav.ToManageCharacters">Manage</button>
                </div>
            </div>
        </div>
    </div>
    <Character Model="Model"/>
</div>

@code{
    private const string ManagePageUrl = "/manageCharacters";
    [Inject] public required StorageService Storage { get; set; }
    public List<CharacterModel> AvailableCharacters { get; set; } = [];
    public CharacterModel Model { get; set; } = new(true);

    protected override async Task OnInitializedAsync()
    {
        var json = await Storage.GetFromLocalStorage("Characters");
        if(string.IsNullOrWhiteSpace(json))
        {
            Console.WriteLine("No saved characters found.");
            return;
        }
        AvailableCharacters = JsonSerializer.Deserialize<List<CharacterModel>>(json) ?? [];
        if (AvailableCharacters.Any())
        {
            Model = AvailableCharacters[0];
        }
    }

    public async Task NewCharacter()
    {
        Console.WriteLine("Saving current character");
        await SaveCharacter();

        Console.WriteLine("Initializing new character");
        Model = new CharacterModel(true);
        StateHasChanged();
    }

    public async Task LoadCharacter(string? characterName)
    {
        if(string.IsNullOrEmpty(characterName))
        {
            return;
        }
        var character = AvailableCharacters.FirstOrDefault(c => c.CharacterName == characterName);
        if(character is null)
        {
            Console.Error.WriteLine("ERROR: Character not found.");
            return;
        }
        Model = character;
        StateHasChanged();
    }

    public async Task SaveCharacter()
    {
        if(string.IsNullOrWhiteSpace(Model.CharacterName))
        {
            Console.Error.WriteLine("ERROR: Character must have a name to be saved.");
            return;
        }
        var existing = AvailableCharacters.FirstOrDefault(c => c.CharacterName == Model.CharacterName);
        if(existing != null)
        {
            Console.WriteLine("Updating existing character.");
            existing = Model;
        }
        else
        {
            Console.WriteLine("Saving new character.");
            AvailableCharacters.Add(Model);
        }
        await Storage.SetToLocalStorage("Characters", JsonSerializer.Serialize(AvailableCharacters));
    }
}