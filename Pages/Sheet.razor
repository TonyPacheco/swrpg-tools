@page "/"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Threading.Tasks

<MudGrid>
    <MudItem xs="8">
        <MudSelect T="string" ValueChanged="LoadCharacter" Placeholder="Select Character">
            @foreach(var character in AvailableCharacters)
            {
                <MudSelectItem value="@character.CharacterName">@character.CharacterName</MudSelectItem>
            }
        </MudSelect>
    </MudItem>
    <MudItem xs="4" Class="d-flex justify-end flex-grow-1 gap-4">
        <MudButton Variant="Variant.Filled" @onclick="NewCharacter">New</MudButton>
        <MudButton Variant="Variant.Filled" @onclick="SaveCharacter">Save</MudButton>
    </MudItem>
</MudGrid>
<br />
<Character Model="Model" />

@code
{
    [Inject] public required StorageService Storage { get; set; }
    public List<CharacterModel> AvailableCharacters { get; set; } = [];
    public CharacterModel Model { get; set; } = new(true);


    protected override async Task OnInitializedAsync()
    {
        var json = await Storage.GetFromLocalStorage("Characters");
        if(string.IsNullOrWhiteSpace(json))
        {
            Console.WriteLine("No saved characters found.");
            return;
        }
        AvailableCharacters = JsonSerializer.Deserialize<List<CharacterModel>>(json) ?? [];
    }

    public async Task NewCharacter()
    {
        Console.WriteLine("Saving current character");
        await SaveCharacter();

        Console.WriteLine("Initializing new character");
        Model = new CharacterModel(true);
        StateHasChanged();
    }

    public async Task LoadCharacter(string characterName)
    {
        if(string.IsNullOrEmpty(characterName))
        {
            return;
        }
        var character = AvailableCharacters.FirstOrDefault(c => c.CharacterName == characterName);
        if(character is null)
        {
            Console.Error.WriteLine("ERROR: Character not found.");
            return;
        }
        Model = character;
        StateHasChanged();
    }

    public async Task SaveCharacter()
    {
        if(string.IsNullOrWhiteSpace(Model.CharacterName))
        {
            Console.Error.WriteLine("ERROR: Character must have a name to be saved.");
            return;
        }
        var existing = AvailableCharacters.FirstOrDefault(c => c.CharacterName == Model.CharacterName);
        if(existing != null)
        {
            Console.WriteLine("Updating existing character.");
            existing = Model;
        }
        else
        {
            Console.WriteLine("Saving new character.");
            AvailableCharacters.Add(Model);
        }
        await Storage.SetToLocalStorage("Characters", JsonSerializer.Serialize(AvailableCharacters));
    }
}